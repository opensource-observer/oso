test_self_merge_rates_to_project_daily:
  model: oso.self_merge_rates_to_project_daily
  vars:
    start: 2024-01-01
    end: 2024-01-31
  inputs:
    oso.int_events_aux_prs:
      columns:
        author_association: varchar
      query: |
        SELECT CAST('2024-01-01 09:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-01 10:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-01 10:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 09:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 11:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-02 11:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 2 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-03 09:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_2' AS from_artifact_id, 'pr_1_3' AS pr_id, 3 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-03 12:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_3' AS from_artifact_id, 'pr_1_3' AS pr_id, 3 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-03 12:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
    oso.artifacts_by_project_v1:
      rows:
      - artifact_id: repo_1
        project_id: project_1
  outputs:
    query:
      rows:
      - metrics_sample_date: 2024-01-01
        event_source: GITHUB
        to_project_id: project_1
        from_artifact_id: ''
        metric: self_merge_rates_daily
        amount: 1
      - metrics_sample_date: 2024-01-02
        event_source: GITHUB
        to_project_id: project_1
        from_artifact_id: ''
        metric: self_merge_rates_daily
        amount: 0
      - metrics_sample_date: 2024-01-03
        event_source: GITHUB
        to_project_id: project_1
        from_artifact_id: ''
        metric: self_merge_rates_daily
        amount: 0


test_self_merge_rates_to_project_daily_multiple_artifacts_in_project:
  model: oso.self_merge_rates_to_project_daily
  vars:
    start: 2024-01-01
    end: 2024-01-02
  inputs:
    oso.int_events_aux_prs:
      columns:
        author_association: varchar
      query: |
        SELECT CAST('2024-01-01 09:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-01 10:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-01 10:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-01 11:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_2' AS to_artifact_id, 'user_2' AS from_artifact_id, 'pr_2_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-01 12:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_2' AS to_artifact_id, 'user_2' AS from_artifact_id, 'pr_2_1' AS pr_id, 1 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-01 12:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 09:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_1' AS from_artifact_id, 'pr_1_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 10:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_1' AS to_artifact_id, 'user_3' AS from_artifact_id, 'pr_1_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-02 10:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 11:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_2' AS to_artifact_id, 'user_2' AS from_artifact_id, 'pr_2_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_OPENED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST(NULL AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
        UNION ALL
        SELECT CAST('2024-01-02 12:00:00.000000' AS TIMESTAMP(6)) AS time, 'repo_2' AS to_artifact_id, 'user_2' AS from_artifact_id, 'pr_2_2' AS pr_id, 2 AS pr_number, 'PULL_REQUEST_MERGED' AS event_type, 'GITHUB' AS event_source, CAST(NULL AS TIMESTAMP(6)) AS created_at, CAST(NULL AS TIMESTAMP(6)) AS closed_at, CAST('2024-01-02 12:00:00.000000' AS TIMESTAMP(6)) AS merged_at, 0 AS comments, CAST(NULL AS VARCHAR) AS author_association, CAST(NULL AS VARCHAR) AS event_source_id
    oso.artifacts_by_project_v1:
      rows:
      - artifact_id: repo_1
        project_id: project_1
      - artifact_id: repo_2
        project_id: project_1
  outputs:
    query:
      rows:
      - metrics_sample_date: 2024-01-01
        event_source: GITHUB
        to_project_id: project_1
        from_artifact_id: ''
        metric: self_merge_rates_daily
        amount: 1.0
      - metrics_sample_date: 2024-01-02
        event_source: GITHUB
        to_project_id: project_1
        from_artifact_id: ''
        metric: self_merge_rates_daily
        amount: 0.5
