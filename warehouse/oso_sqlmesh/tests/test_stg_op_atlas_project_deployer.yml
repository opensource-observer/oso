test_stg_op_atlas_project_deployer:
  gateway: local
  model: oso.stg_op_atlas_project_deployer
  vars:
    start: 2024-01-01
    end: 2024-02-01
  inputs:
    # Mock inputs for @oso_source('bigquery.op_atlas.project_contract')
    # This source is used for deployers as per the staging model.
    bigquery.op_atlas.project_contract:
      rows:
      - comment: "Mock for @oso_source"
    bigquery.bq_op_atlas.project_contract:
      rows:
      - comment: "Mock for @oso_source"
    sources__bigquery__op_atlas.project_contract: # Actual data for the project_contract table
      rows:
      - project_id: "dep_proj1"
        deployer_address: "0xabcDeployer1" # Will be lowercased
        chain_id: 1 # Mainnet
        updated_at: "2025-01-15T00:00:00Z" # Newer
      - project_id: "dep_proj1" # Same project, same deployer, older update (should be filtered by ROW_NUMBER)
        deployer_address: "0xabcDeployer1"
        chain_id: 1
        updated_at: "2025-01-01T00:00:00Z" # Older
      - project_id: "dep_proj1" # Same project, different deployer
        deployer_address: "0xdefDeployer2" # Will be lowercased
        chain_id: 10 # Optimism
        updated_at: "2025-01-10T00:00:00Z"
      - project_id: "dep_proj2"
        deployer_address: "0xghiDeployer3"
        chain_id: 8453 # Base
        updated_at: "2025-01-20T00:00:00Z"
      - project_id: "dep_proj3" # Deployer address is null
        deployer_address: NULL
        chain_id: 1
        updated_at: "2025-01-21T00:00:00Z"
      - project_id: "dep_proj4" # Chain_id is null
        deployer_address: "0xjklDeployer4"
        chain_id: NULL
        updated_at: "2025-01-22T00:00:00Z"

  outputs:
    query:
      rows:
      # For dep_proj1, 0xabcDeployer1 on chain 1, only the one with the latest updated_at
      - atlas_id: "dep_proj1"
        deployer_address: "0xabcdeployer1" # Lowercased
        chain_id: 1
        updated_at: "2025-01-15"
      - atlas_id: "dep_proj1"
        deployer_address: "0xdefdeployer2" # Lowercased
        chain_id: 10
        updated_at: "2025-01-10"
      - atlas_id: "dep_proj2"
        deployer_address: "0xghideployer3" # Lowercased
        chain_id: 8453
        updated_at: "2025-01-20"
