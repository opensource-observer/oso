MODEL (
  name oso.int_ddp_repo_discovery_v0_shortlist,
  kind FULL,
  dialect trino,
  tags (
    'entity_category=artifact',
    'entity_category=project'
  ),
  audits (
    has_at_least_n_rows(threshold := 0)
  ),
  description 'Filtered and enriched shortlist of repositories discovered by the DDP v0 discovery algorithm. This model applies a configurable trust score threshold (default 0.5) to filter repositories from the discovery results, excludes pre-trust repositories, and enriches each repository with comprehensive classification flags, commit metrics, and contributor counts. The model identifies repositories that are likely related to Ethereum development based on developer contribution patterns and trust propagation. Repositories are classified by their relationship to crypto ecosystems, presence in various registries (OSS Directory, OP Atlas, Gitcoin), ownership patterns, and lineage relationships. Business questions that can be answered include: Which discovered repositories have the highest trust scores? Which repositories are owned by maintainers already in crypto ecosystems? Which repositories appear in multiple registries (OP Atlas, Gitcoin, OSS Directory)? Which repositories have contributed to packages in deps.dev? What is the contributor count distribution among high-trust discovered repositories?',
  column_descriptions (
    repo_artifact_id = 'The unique identifier for the repository artifact, as generated by OSO.',
    url = 'The full GitHub repository URL in the format https://github.com/{owner}/{repo}.',
    repo_maintainer = 'The GitHub organization or user account that owns the repository (artifact_namespace).',
    repo_name = 'The name of the GitHub repository (artifact_name).',
    final_score = 'The final trust score assigned to this repository by the DDP v0 discovery algorithm, representing the repository''s relationship strength to Ethereum development based on developer contribution patterns. Scores range from 0 to 1, with higher scores indicating stronger relationships.',
    is_personal_repo = 'Boolean flag indicating whether the repository maintainer (owner) is a personal GitHub user account rather than an organization.',
    is_package_owner = 'Boolean flag indicating whether this repository owns one or more packages listed in deps.dev (npm registry), determined by checking if the repository artifact_id appears as a package_owner_artifact_id.',
    is_in_crypto_ecosystems = 'Boolean flag indicating whether this repository itself is listed in the crypto ecosystems taxonomy (Ethereum, EVM L1/L2, Solana) as a project artifact.',
    is_maintainer_in_crypto_ecosystems = 'Boolean flag indicating whether the repository maintainer (artifact_namespace) has any repositories listed in the crypto ecosystems taxonomy, indicating the maintainer is associated with crypto ecosystems.',
    is_in_ossd = 'Boolean flag indicating whether this repository is listed in the OSS Directory registry (GitHub repositories only).',
    is_in_op_atlas = 'Boolean flag indicating whether this repository is listed in the OP Atlas registry (GitHub repositories only).',
    is_in_gitcoin = 'Boolean flag indicating whether this repository is listed in the Gitcoin registry (GitHub repositories only).',
    is_in_lineage_family = 'Boolean flag indicating whether this repository artifact_id appears in the lineage family_artifact_ids array of any DDP repository, meaning it shares commit history or source IDs with known DDP repositories through repository migrations or renames.',
    first_commit_time = 'The timestamp of the earliest commit to this repository across all observed artifact_source_ids. Aggregated from int_first_last_commit_to_github_repository.',
    last_commit_time = 'The timestamp of the most recent commit to this repository across all observed artifact_source_ids. Aggregated from int_first_last_commit_to_github_repository.',
    contributor_count = 'The total number of distinct contributors who have made commits to this repository. This value comes from pre-aggregated metrics in key_metrics_by_artifact_v0 and defaults to 0 if no contributor data is available.'
  )
);

@DEF("trust_score_threshold", 0.5);

WITH shortlist AS (
  SELECT DISTINCT
    url,
    repo_artifact_id,
    a.artifact_namespace AS repo_maintainer,
    a.artifact_name AS repo_name,
    final_score
  FROM oso.int_ddp_repo_discovery_v0
  CROSS JOIN @parse_github_repository_artifact(url) AS a
  WHERE
    final_score >= @trust_score_threshold
    AND NOT is_pretrust
),
-- Flatten lineage family artifact IDs for efficient lookup
lineage_family_flattened AS (
  SELECT DISTINCT
    t.artifact_id AS family_artifact_id
  FROM oso.int_ddp_repo_lineage AS lin
  CROSS JOIN UNNEST(lin.family_artifact_ids) AS t(artifact_id)
  WHERE lin.family_artifact_ids IS NOT NULL
),
-- Consolidated boolean checks using LEFT JOINs instead of separate CTEs with IN subqueries
repo_checks AS (
  SELECT
    s.repo_artifact_id,
    CASE WHEN gu.artifact_name IS NOT NULL THEN TRUE END AS is_personal_repo,
    CASE WHEN pkg.package_owner_artifact_id IS NOT NULL THEN TRUE END AS is_package_owner,
    CASE WHEN ce.artifact_id IS NOT NULL THEN TRUE END AS is_in_crypto_ecosystems,
    CASE WHEN ce_maintainer.artifact_namespace IS NOT NULL THEN TRUE END AS is_maintainer_in_crypto_ecosystems,
    CASE WHEN ossd.artifact_id IS NOT NULL THEN TRUE END AS is_in_ossd,
    CASE WHEN op_atlas.artifact_id IS NOT NULL THEN TRUE END AS is_in_op_atlas,
    CASE WHEN gitcoin.artifact_id IS NOT NULL THEN TRUE END AS is_in_gitcoin,
    CASE WHEN lff.family_artifact_id IS NOT NULL THEN TRUE END AS is_in_lineage_family
  FROM shortlist AS s
  LEFT JOIN oso.int_github_users AS gu
    ON s.repo_maintainer = gu.artifact_name
  LEFT JOIN oso.int_packages__current_maintainer_only AS pkg
    ON s.repo_artifact_id = pkg.package_owner_artifact_id
  LEFT JOIN oso.int_artifacts_by_project_in_crypto_ecosystems AS ce
    ON s.repo_artifact_id = ce.artifact_id
    AND ce.project_source = 'CRYPTO_ECOSYSTEMS'
    AND ce.project_namespace = 'eco'
  LEFT JOIN oso.int_artifacts_by_project_in_crypto_ecosystems AS ce_maintainer
    ON s.repo_maintainer = ce_maintainer.artifact_namespace
    AND ce_maintainer.project_source = 'CRYPTO_ECOSYSTEMS'
    AND ce_maintainer.project_namespace = 'eco'
  LEFT JOIN oso.int_artifacts_by_project_in_ossd AS ossd
    ON s.repo_artifact_id = ossd.artifact_id
    AND ossd.artifact_source = 'GITHUB'
  LEFT JOIN oso.int_artifacts_by_project_in_op_atlas AS op_atlas
    ON s.repo_artifact_id = op_atlas.artifact_id
    AND op_atlas.artifact_source = 'GITHUB'
  LEFT JOIN oso.int_artifacts_by_project__gitcoin AS gitcoin
    ON s.repo_artifact_id = gitcoin.artifact_id
    AND gitcoin.artifact_source = 'GITHUB'
  LEFT JOIN lineage_family_flattened AS lff
    ON s.repo_artifact_id = lff.family_artifact_id
),
commit_metrics AS (
  SELECT
    s.repo_artifact_id,
    MIN(cm.first_commit_time) AS first_commit_time,
    MAX(cm.last_commit_time) AS last_commit_time
  FROM oso.int_first_last_commit_to_github_repository AS cm
  INNER JOIN shortlist AS s
    ON s.repo_artifact_id = cm.artifact_id
  GROUP BY s.repo_artifact_id
),
contributor_counts AS (
  SELECT
    s.repo_artifact_id,
    MAX(km.amount) AS contributor_count
  FROM oso.key_metrics_by_artifact_v0 AS km
  INNER JOIN shortlist AS s
    ON s.repo_artifact_id = km.artifact_id
  INNER JOIN oso.metrics_v0 AS m
    ON km.metric_id = m.metric_id
    AND m.metric_model = 'contributors'
  GROUP BY s.repo_artifact_id
),

final AS (
  SELECT
    s.repo_artifact_id,
    s.url,
    s.repo_maintainer,
    s.repo_name,
    s.final_score,
    rc.is_personal_repo,
    rc.is_package_owner,
    rc.is_in_crypto_ecosystems,
    rc.is_maintainer_in_crypto_ecosystems,
    rc.is_in_ossd,
    rc.is_in_op_atlas,
    rc.is_in_gitcoin,
    rc.is_in_lineage_family,
    cm.first_commit_time,
    cm.last_commit_time,
    COALESCE(cnt.contributor_count, 0) AS contributor_count
  FROM shortlist AS s
  LEFT JOIN repo_checks AS rc
    ON s.repo_artifact_id = rc.repo_artifact_id
  LEFT JOIN commit_metrics AS cm
    ON s.repo_artifact_id = cm.repo_artifact_id
  LEFT JOIN contributor_counts AS cnt
    ON s.repo_artifact_id = cnt.repo_artifact_id
)

SELECT DISTINCT
  repo_artifact_id,
  url,
  repo_maintainer,
  repo_name,
  final_score,
  is_personal_repo,
  is_package_owner,
  is_in_crypto_ecosystems,
  is_maintainer_in_crypto_ecosystems,
  is_in_ossd,
  is_in_op_atlas,
  is_in_gitcoin,
  is_in_lineage_family,
  first_commit_time,
  last_commit_time,
  contributor_count
FROM final