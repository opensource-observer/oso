MODEL (
  name oso.int_s6_growth_grants,
  kind INCREMENTAL_BY_TIME_RANGE (
    time_column transaction_day,
    batch_size 365,
    batch_concurrency 1
  ),
  start @github_incremental_start,
  cron '@daily',
  dialect trino,
  partitioned_by (DAY(transaction_day), project_name),
  grain (transaction_day, project_name),
  tags (
    'entity_category=project'
  ),
  audits (
    not_null(columns := (project_name, transaction_day))
  )
);

WITH allowed_projects AS (
    SELECT project_id
    FROM (VALUES
      ('kLJHMLtT9xS11VH/AL+t50dQK84VQFYn1rfM5QOk9q4='),
      ('FfxHG1h+bCSAcmjqHwxG61O12Y/AkGgaMPRu584e6zU='),
      ('ntm9O3vN93SUVL2cPJ4tC4BT1W8ZSMoJshsr1mGNlvQ='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('bHGrs5wFQsPVTRZ9AALMgCizZwlL1BrL6iFLaIo9F2k='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('RGNaZ+2RZeyelbd0QTGuPoxxsWBAELADGbDLHn347v0='),
      ('eid5gZ3mC0JHbMYg33dvcofcqwp2cvkhO3LZAt8fl7A='),
      ('I9lY6iNLCfuKNKDt5SQZVE6/eEvlqKMlURFU3BveLJI='),
      ('5/9fRbVoDF7pHwBdiMbNUbKhidEt/12Ojt9f8cWoZnQ='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('LYqqNPxTsrpTYQolk1oV3UWxDqb61pQP3hIDfEh91SY='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('3+YJJ+R/YTcUBaWWtwlUExIODroWXXIRt9EPB+mlT0g='),
      ('8cby1aMn7r59alz/BdKfcrjF0m4W+I2AYffy8Ac85Iw='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('b2z2hr0LC4v4hHbL9LkEskx+P+3XZ4S8cG6PeezOgcI='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('EwhgKbiUWD445lZ44ZOgAzBUTqhtXX6o/GJSKjy4Em8='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('ntm9O3vN93SUVL2cPJ4tC4BT1W8ZSMoJshsr1mGNlvQ='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('1PqWi/6kQu3j9O311xKAqoA9vYRJjIlLefadHnswYrE='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('VGUIq4rEXtAwcesetQyta4todTNXTpvpfHvczoJu0EQ='),
      ('wU3VSYPW+PeBUKcHkary8+KjYnf5ERgLIBoM4libPFM='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('jeSuNaJdsXDqq5y/C9zSGO3U6s9P4EJ/XV5bTejQ/kA='),
      ('HeEmtoqJ5hWXVqsvaWPchnXyntWhoOhPUXoW0S8Mgoc='),
      ('b2z2hr0LC4v4hHbL9LkEskx+P+3XZ4S8cG6PeezOgcI='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('ZC6qiEx2ibDoK9Hr7YIsh2YT/vr/0rSfZT4LdvJG10s='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('jeSuNaJdsXDqq5y/C9zSGO3U6s9P4EJ/XV5bTejQ/kA='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('8cby1aMn7r59alz/BdKfcrjF0m4W+I2AYffy8Ac85Iw='),
      ('swsq1vWkoGPZXz3zXY+RKpFZO86SG8M0M69el1mleao='),
      ('18oCUnIwrpIlijNIkE6J4BYxWFKh/si45CQei827/V0='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('ExxaaR22Tn/4Q9iPwgzHc0FARRe+To/T1HFPcSJqi68='),
      ('rV6VRIUtgdaeu5+g1y7vloRmK9sbBEl3rFCs1r7OR7A='),
      ('ec9PEUQwIfXCq7fpDHA2JwxwoxTgF+8o62D67ixlTbM='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('swsq1vWkoGPZXz3zXY+RKpFZO86SG8M0M69el1mleao='),
      ('RGNaZ+2RZeyelbd0QTGuPoxxsWBAELADGbDLHn347v0='),
      ('DLB4HU/AbX6tCEx1zy/gpmR7jwnlzBGuArfPROWPcEY='),
      ('EwhgKbiUWD445lZ44ZOgAzBUTqhtXX6o/GJSKjy4Em8='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('HeEmtoqJ5hWXVqsvaWPchnXyntWhoOhPUXoW0S8Mgoc='),
      ('bHGrs5wFQsPVTRZ9AALMgCizZwlL1BrL6iFLaIo9F2k='),
      ('acLbg/o7PunNI4NUSzSz4p2w6cE9YT3WspWcziZEZcQ='),
      ('IC4gXIZe/sWGrV5sOyeoSlqkS7t4BZd40afZT+2Q7bA='),
      ('IC4gXIZe/sWGrV5sOyeoSlqkS7t4BZd40afZT+2Q7bA='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('b2z2hr0LC4v4hHbL9LkEskx+P+3XZ4S8cG6PeezOgcI='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('ZC6qiEx2ibDoK9Hr7YIsh2YT/vr/0rSfZT4LdvJG10s='),
      ('acLbg/o7PunNI4NUSzSz4p2w6cE9YT3WspWcziZEZcQ='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('7CbZT+Alw8Biv6iCgptzNOvAwOUFg3FBfHQ/Msuw4no='),
      ('1Ll7MLXCxNJFxQCuBEdRnRVk164keWjynVtQJF++xGU='),
      ('RGNaZ+2RZeyelbd0QTGuPoxxsWBAELADGbDLHn347v0='),
      ('RGNaZ+2RZeyelbd0QTGuPoxxsWBAELADGbDLHn347v0='),
      ('M7mj4E6rVNxqX6O3QbNNaworQ4q/zn9J1XKeZ4Ch2lY='),
      ('wU3VSYPW+PeBUKcHkary8+KjYnf5ERgLIBoM4libPFM='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('acLbg/o7PunNI4NUSzSz4p2w6cE9YT3WspWcziZEZcQ='),
      ('Fd8HVLZXA/EEsfdbd6C14XECawRTGoQWTzOppQYsutw='),
      ('HG82ZJgWrvt0Nq2de4DtXoNFMaCv22KSY72BQs6+bNc='),
      ('pWEQHj4IsxU8lx2EDLJpphYaGAvw/yRps3vgTbVCXjQ='),
      ('xOZNIZHXWrA+JWBmcsHybyHDy0WZy/gOyw1VaqAupG0='),
      ('wU3VSYPW+PeBUKcHkary8+KjYnf5ERgLIBoM4libPFM='),
      ('LeZtrTb17YL2xsyyAwVaZQ4d4p/vDrpYVwohFyTDGOs='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0='),
      ('ZzH9XQNZ7nWOlugpkz8GaQQEmQzx1rKxaPrvhJ+l87Y='),
      ('om+w927v3zYcmk77AShf/wH4sac6MkhpIWBW0H/wYkE='),
      ('hifa3oKYJHXbxX7VufyntfwuYU6fmzduDXVn+m2oZy0=')
    ) AS t(project_id)
)

SELECT
    p.project_name,
    DATE_TRUNC('DAY', tm.sample_date) AS transaction_day,
    SUM(CASE WHEN m.metric_name LIKE '%transactions_daily' THEN tm.amount ELSE 0 END) AS transactions,
    SUM(CASE WHEN m.metric_name LIKE '%active_addresses_daily' THEN tm.amount ELSE 0 END) AS active_addresses,
    SUM(CASE WHEN m.metric_name LIKE '%gas_fees_daily' THEN tm.amount ELSE 0 END) AS gas_fees
FROM oso.projects_v1 p 
JOIN oso.int_artifacts_by_project_all_sources a ON p.project_id = a.project_id
JOIN oso.timeseries_metrics_by_artifact_v0 tm ON a.artifact_id = tm.artifact_id
JOIN oso.metrics_v0 m ON m.metric_id = tm.metric_id
WHERE tm.sample_date >= DATE '2024-01-01'
    AND p.project_id IN (SELECT project_id FROM allowed_projects)
GROUP BY
    p.project_name,
    DATE_TRUNC('DAY', tm.sample_date)
