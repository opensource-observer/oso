# Aug 18, 2025

## Text2SQL Semantic Workflow Composition

This workflow converts natural language queries into SQL statements through
semantic analysis and vector-based context retrieval.

### Key Components

- **SemanticText2SQLWorkflow**: Orchestrates semantic translation and handles
  retry logic
- **OsoVectorDatabaseMixin**: Performs schema analysis and retrieves row context
  using vector embeddings
- **GenericText2SQLRouter**: Routes events and manages execution/synthesis flags
- **OsoDBWorkflow**: Executes SQL queries against the database
- **SQLRowsResponseSynthesisMixin**: Converts SQL results into natural language
  responses

### Flow Elements

1. **Context Gathering**: Schema analysis and row context retrieval using vector
   retrievers
2. **Entity Context Extraction**: Extracts relevant entities from vector
   retrievers before translation
3. **Semantic Translation**: Uses `semantic_query_tool.acall` with entity
   context to generate SQL
4. **Retry Mechanism**: On failure, retrieves vector context directly and
   retries translation
5. **Optional Execution**: SQL execution controlled by `execute_sql` flag
6. **Optional Synthesis**: Response generation controlled by
   `synthesize_response` flag

### Execution Flow

The workflow begins by analyzing the database schema and gathering relevant row
examples through vector embeddings. It then extracts entity context from these
retrievers and passes this information to the semantic query tool for SQL
translation. If translation fails, the system retrieves vector context directly
and retries the process. Once successful SQL is generated, the workflow
optionally executes the query against the database and synthesizes a natural
language response from the results.

### Flow diagram

```mermaid
graph TD
    A[Text2SQLStartEvent] --> B[initiate_query_engine]
    B --> C[StartQueryEngineEvent]

    C --> D[OsoVectorDatabaseMixin:<br/>analyze_schema]
    D --> E[SchemaAnalysisEvent]

    E --> F[OsoVectorDatabaseMixin:<br/>retrieve_row_context]
    F --> G[RowContextEvent<br/>+ vector retrievers]

    G --> H[SemanticText2SQLWorkflow:<br/>handle_row_context_for_semantic_translation]
    H --> H1[Extract entity context<br/>from vector retrievers]
    H1 --> H2[Call _perform_semantic_translation<br/>max_retries + empty error_context]

    H2 --> I[SemanticText2SQLWorkflow:<br/>_perform_semantic_translation]
    I --> I1[semantic_query_tool.acall<br/>with entity_context]
    I1 --> J{Success?}

    J -->|Yes| K[SemanticQueryEvent]
    J -->|No| L[RetrySemanticQueryEvent]

    L --> M[SemanticText2SQLWorkflow:<br/>start_translation retry handler]
    M --> M1[Get vector context directly<br/>for retry attempt]
    M1 --> M2[Call _perform_semantic_translation<br/>with retry state]
    M2 --> I

    K --> N[SemanticText2SQLWorkflow:<br/>build_sql_from_semantic_query]
    N --> O{Success?}
    O -->|Yes| P[Text2SQLGenerationEvent]
    O -->|No| L

    P --> Q[GenericText2SQLRouter:<br/>handle_text2sql_generation_event]
    Q --> R{execute_sql?}

    R -->|Yes| S[SQLExecutionRequestEvent]
    R -->|No| T[StopEvent<br/>SqlResponse]

    S --> U[OsoDBWorkflow:<br/>retrieve_sql_results]
    U --> V[SQLResultEvent]

    V --> W[GenericText2SQLRouter:<br/>handle_sql_results_rows]
    W --> WW{synthesize_response?}
    WW -->|Yes| X[SQLResultSummaryRequestEvent]
    WW -->|No| Y[StopEvent<br/>AnyResponse]

    X --> Z[SQLRowsResponseSynthesisMixin:<br/>synthesize_sql_response_from_rows]
    Z --> AA[SQLResultSummaryResponseEvent]

    AA --> BB[SemanticText2SQLWorkflow:<br/>return_response]
    BB --> CC[StopEvent<br/>StrResponse]

    %% OsoVectorDatabaseMixin - Light Blue
    style D fill:#b3e5fc,color:#000
    style F fill:#b3e5fc,color:#000

    %% SemanticText2SQLWorkflow - Light Purple
    style H fill:#e1bee7,color:#000
    style I fill:#e1bee7,color:#000
    style M fill:#e1bee7,color:#000
    style N fill:#e1bee7,color:#000
    style BB fill:#e1bee7,color:#000

    %% Vector Context Operations - Light Green
    style H1 fill:#c8e6c9,color:#000
    style M1 fill:#c8e6c9,color:#000

    %% Enhanced Semantic Tool - Yellow
    style I1 fill:#ffcc02,color:#000

    %% GenericText2SQLRouter - Light Orange
    style Q fill:#ffcc80,color:#000
    style W fill:#ffcc80,color:#000

    %% OsoDBWorkflow - Light Red
    style U fill:#ffcdd2,color:#000

    %% SQLRowsResponseSynthesisMixin - Light Cyan
    style Z fill:#b2dfdb,color:#000
```
