mutation StartRun($runId: ID!) {
  startRun(input: {runId: $runId}) {
    success
  }
}

mutation UpdateRunMetadata(
  $runId: ID!
  $metadata: UpdateMetadataInput!
) {
  updateRunMetadata(input: {runId: $runId, metadata: $metadata}) {
    success
    message
    run {
      id
    }
  }
}

mutation FinishRun(
  $runId: ID!
  $status: RunStatus!
  $statusCode: Int!
  $logsUrl: String!
  $metadata: UpdateMetadataInput
) {
  finishRun(input: {runId: $runId, status: $status, statusCode: $statusCode, logsUrl: $logsUrl, metadata: $metadata}) {
    success
    message
    run {
      id
    }
  }
}

mutation StartStep(
  $runId: ID!, 
  $name: String!, 
  $displayName: String!
) {
  startStep(input: {runId: $runId, name: $name, displayName: $displayName}) {
    success
    message
    step {
      id
    }
  }
}

mutation FinishStep(
  $stepId: ID!, 
  $status: StepStatus!, 
  $logsUrl: String!
) {
  finishStep(input: {stepId: $stepId, status: $status, logsUrl: $logsUrl}) {
    success
    message
    step {
      id
    }
  }
}

mutation CreateMaterialization(
  $stepId: ID!
  $tableId: ID!
  $warehouseFqn: String!
  $schema: [DataModelColumnInput!]!
) {
  createMaterialization(input: {
    stepId: $stepId, 
    tableId: $tableId,
    warehouseFqn: $warehouseFqn,
    schema: $schema
  }) {
    success
    materialization {
      id
    }
  }
}

fragment OrganizationCommon on Organization {
  id
  name
}

fragment UserCommon on User {
  id
  email
}

fragment RunCommon on Run {
  id
  metadata
  triggerType
  organization {
    ...OrganizationCommon
  }
  dataset {
    ...DatasetCommon
  }
  requestedBy {
    ...UserCommon
  }
}


mutation SavePublishedNotebookHtml($notebookId: ID!, $htmlContent: String!) {
  savePublishedNotebookHtml(
    input: { notebookId: $notebookId, htmlContent: $htmlContent }
  ) {
    success
  }
}

fragment DatasetCommon on Dataset {
  id
  name
  displayName
  description
  organization {
    ...OrganizationCommon
  }
}

fragment LatestDataModel on DataModel {
  id
  orgId
  isEnabled
  createdAt
  latestRelease {
    id
    revision {
      name
      description
      code
      dependsOn {
        alias
        tableId
      }
      hash
      kind
      kindOptions {
        timeColumn
        timeColumnFormat
        batchSize
        lookback
        uniqueKeyColumns
        whenMatchedSql
        mergeFilter
        validFromName
        validToName
        invalidateHardDeletes
        updatedAtColumn
        updatedAtAsValidFrom
        scdColumns
        executionTimeAsValidFrom
      }
      partitionedBy
      schema {
        name
        type
        description
      }
      start
      end
      clusteredBy
      language
    }
  }
}

fragment DataModels on DataModelConnection {
  edges {
    node {
      ...LatestDataModel
    }
  }
}

query GetRun($runId: ID!) {
  runs(where: { id: { eq: $runId }}, single: true) {
    edges {
      node {
        ...RunCommon
      }
    }
  }
}

query GetDataModels($datasetId: ID!) {
  datasets(where: { id: { eq: $datasetId }}) {
    edges {
      node {
        ...DatasetCommon
        typeDefinition {
          ... on DataModelDefinition {
            dataModels(where: { is_enabled: {eq: true}}) {
              ...DataModels
            }
          }
        }
      }
    }
  }
}

query GetDataIngestionConfig($datasetId: ID!) {
  datasets(where: { id: { eq: $datasetId }}, single: true) {
    edges {
      node {
        ...DatasetCommon
        typeDefinition {
          ... on DataIngestionDefinition {
            dataIngestion {
              id
              datasetId
              factoryType
              config
            }
          }
        }
      }
    }
  }
}

query GetStaticModels($datasetId: ID!) {
  datasets(where: { id: { eq: $datasetId }}) {
    edges {
      node {
        ...DatasetCommon
        typeDefinition {
          ... on StaticModelDefinition {
            staticModels {
              edges {
                node {
                  id
                  name
                }
              }
            }
          }
        }
      }
    }
  }
}

query ResolveTables($references: [String!]!, $metadata: JSON) {
  system {
    resolveTables(references: $references, metadata: $metadata) {
      reference
      fqn
    }
  }
}

query GetNotebook($notebookId: ID!) {
  notebooks(where: { id: { eq: $notebookId } }, single: true) {
    edges {
      node {
        id
        name
        data
      }
    }
  }
}

