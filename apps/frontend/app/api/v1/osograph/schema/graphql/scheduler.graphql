"""
The scheduler schema defines types and queries related to scheduling data model
runs and ingest jobs.

Runs are a generic representation of a data task that has been executed. So it's
meant to be quite flexible to accommodate different types of runs in the future.
"""

enum RunTriggerType {
  MANUAL
  SCHEDULED
}

enum RunType {
  MANUAL
  SCHEDULED
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  CANCELED
}

enum StepStatus {
  RUNNING
  SUCCESS
  FAILED
  CANCELED
}

type Run {
  id: ID!
  orgId: ID!
  organization: Organization!
  datasetId: ID
  dataset: Dataset
  triggerType: RunTriggerType!
  runType: RunType!
  requestedBy: User
  queuedAt: DateTime!
  startedAt: DateTime
  finishedAt: DateTime
  status: RunStatus!

  """
  The logs urls is returned as a presigned url to a cloud storage location. Use
  a GET request on this URL to retrieve the logs for the run.
  """
  logsUrl: String

  steps: StepConnection!
  metadata: JSON
}

type RunEdge {
  node: Run!
  cursor: String!
}

type RunConnection {
  edges: [RunEdge!]!
  pageInfo: PageInfo!
  totalCount: Int
}

type Step {
  id: ID!
  runId: ID!
  run: Run!
  name: String!
  displayName: String!
  logsUrl: String!
  startedAt: DateTime!
  finishedAt: DateTime
  status: StepStatus!
  materializations: MaterializationConnection!
}

type StepEdge {
  node: Step!
  cursor: String!
}

type StepConnection {
  edges: [StepEdge!]!
  pageInfo: PageInfo!
  totalCount: Int
}

"""
The materialization type represents the output of a run step that has
materialized data. For example, for a data model run, each materialization would
represent the output of a model execution. Each materialization is directly
associated with a table in the OSO data catalog.
"""
type Materialization {
  id: ID!
  runId: ID!
  run: Run!
  stepId: ID!
  step: Step!
  datasetId: ID!
  createdAt: DateTime!
  schema: [DataModelColumn!]
}

type MaterializationEdge {
  node: Materialization!
  cursor: String!
}

type MaterializationConnection {
  edges: [MaterializationEdge!]!
  pageInfo: PageInfo!
  totalCount: Int
}

extend type Query {
  """
  List all runs with optional filtering and pagination.

  The where parameter accepts a JSON object with field-level filtering.
  Each field can have comparison operators: eq, neq, gt, gte, lt, lte, in, like, ilike, is

  Example:
  ```json
  {
    "status": { "eq": "RUNNING" },
    "datasetId": { "eq": "dataset-uuid" }
  }
  ```
  """
  runs(
    first: Int = 50
    after: String
    single: Boolean
    where: JSON
  ): RunConnection!
}

extend type Mutation {
  """
  Request a run for a USER_MODEL dataset
  """
  createUserModelRunRequest(
    input: CreateUserModelRunRequestInput!
  ): CreateRunRequestPayload!

  """
  Request a run for a DATA_INGEST dataset
  """
  createDataIngestionRunRequest(
    input: CreateDataIngestionRunRequestInput!
  ): CreateRunRequestPayload!

  """
  Request a run for a DATA_CONNECTION dataset
  """
  createDataConnectionRunRequest(
    input: CreateDataConnectionRunRequestInput!
  ): CreateRunRequestPayload!

  """
  Request a run for a STATIC_MODEL
  """
  createStaticModelRunRequest(
    input: CreateStaticModelRunRequestInput!
  ): CreateRunRequestPayload! 

  """
  Cancel a run
  """
  cancelRun(input: CancelRunInput!): CancelRunPayload!
}

input CreateUserModelRunRequestInput {
  """
  The ID of the dataset to run. This must be a USER_MODEL dataset.
  """
  datasetId: ID!

  """
  For user model runs, users can optionally specify a list of data model release
  IDs to run. If not provided, all models will be run in topological order based
  on dependencies.
  """
  selectedModels: [String!]
}

input CreateDataIngestionRunRequestInput {
  datasetId: ID!
}

input CreateDataConnectionRunRequestInput {
  datasetId: ID!
}

input CreateStaticModelRunRequestInput {
  """
  The ID of the static model dataset to run.
  """
  datasetId: ID!

  """
  For static model runs, users can optionally specify a list of model IDs to
  run. If not provided, all models will be run.
  """
  selectedModels: [String!]
}

type CreateRunRequestPayload {
  success: Boolean!

  message: String
  
  """
  The run that was created as a result of the run request. The response from the
  `*RunRequest` mutations kick off asynchronous processes. It is possible for
  the run creation to succeed but for the run to ultimately fail due to errors
  encountered during the asynchronous execution. Therefore, the `success` field
  in the payload only indicates whether the run request was successfully
  created, not whether the run itself was successful. Retrieve the run by
  querying for runs within a dataset to check the status and results of the run.
  """
  run: Run!
}

input CancelRunInput {
  runId: ID!
}

type CancelRunPayload {
  success: Boolean!
  message: String
  run: Run
}
